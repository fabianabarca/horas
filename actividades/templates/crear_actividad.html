{% extends 'base.html' %}

{% load static %}

{% load crispy_forms_tags %}

{% block page_title %} Nueva actividad {% endblock %}

{% block main %}

<!-- Formulario de registro de áreas -->

<div class="card">
  <div class="card-header fw-semibold">
    <div class="d-flex justify-content-between">
      <div>
        {% if crear %} Registro de nueva actividad {% else %} Edición de actividad del {{ actividad.fecha | lower }} {% endif %}
      </div>
      <div>
        <span class="badge text-bg-dark"><i class="cil-clock"></i></span>
      </div>
    </div>
  </div>
  <div class="card-body">
    <p>Las horas de TCU son registradas como actividades.</p>
    <form method="POST" onsubmit="setFormSubmitting()">
      {% csrf_token %}
      <p>
      <!-- Mensajes -->
      {% if messages %}
      {% for message in messages %}
      {% if message.tags == 'error' %}
      <div class="alert alert-danger" role="alert">
      {% else %}
      <div class="alert alert-{{ message.tags }}" role="alert">
      {% endif %}
      {{ message }}
      </div>
      {% endfor %}
      {% endif %}
      <!-- Formulario -->
      {{ form | crispy }}
      </p>
      <button type="submit" class="btn btn-primary btn-block">Registrar</button>
    </form>
  </div>
</div>

<hr>

<div class="container">

  <div class="alert alert-success" role="alert" style="display:none">
    <i class="material-icons">done</i> El registro de actividad se ha realizado exitosamente.
  </div>


  </br>

  {% if tipoAccion %}
  <h1>Agregar actividad</h1>
  {% else %}
  <h1>Editar actividad</h1>
  {% endif %}

  <form method="post" onsubmit="setFormSubmitting()" id="actividadesForm"
    data-objetivos-url="{% url 'load_objetivosActividades' %}" data-tareas-url="{% url 'load_tareas' %}">
    {% csrf_token %}
    <input type="hidden" name="next" value="{{ next }}" />

    {{ form|crispy }}

    <button type="submit" onClick="return confirmarRegistro();" class="btn btn-primary btn-block">Continuar</button>
  </form>
  <!--Usando código modificado de https://github.com/akjasim/cb_dj_dependent_dropdown
  Para permitir que el dropdown sea limitado por la eleccion de proyecto
  -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>
    $("#id_proyecto").change(function () {
      console.log("activado accion proyecto");
      const url = $("#actividadesForm").attr("data-objetivos-url");  // get the url of the `load_cities` view
      const proyectoId = $(this).val();  // get the selected country ID from the HTML input

      $.ajax({                       // initialize an AJAX request
        url: url,                    // set the url of the request (= /persons/ajax/load-cities/ )
        data: {
          'proyecto_id': proyectoId       // add the country id to the GET parameters
        },
        success: function (data) {   // `data` is the return of the `load_cities` view function
          $("#id_objetivo").html(data);  // replace the contents of the city input with the data that came from the server
          /*

          let html_data = '<option value="">---------</option>';
          data.forEach(function (objetivo) {
              html_data += `<option value="${objetivo.id}">${objetivo.nombre}</option>`
          });
          console.log(html_data);
          $("#id_objetivo").html(html_data);
*/

        }
      });
    });

  </script>



  <script>
    $("#id_objetivo").change(function () {
      console.log("activado accion objetivo");
      const url = $("#actividadesForm").attr("data-tareas-url");  // get the url of the `load_cities` view
      const objetivoId = $(this).val();  // get the selected country ID from the HTML input

      $.ajax({                       // initialize an AJAX request
        url: url,                    // set the url of the request (= /persons/ajax/load-cities/ )
        data: {
          'objetivo_id': objetivoId       // add the country id to the GET parameters
        },
        success: function (data) {   // `data` is the return of the `load_cities` view function
          $("#id_tarea").html(data);  // replace the contents of the city input with the data that came from the server
          /*
 
          let html_data = '<option value="">---------</option>';
          data.forEach(function (objetivo) {
              html_data += `<option value="${objetivo.id}">${objetivo.nombre}</option>`
          });
          console.log(html_data);
          $("#id_objetivo").html(html_data);
*/
        }
      });
    });
  </script>

<!-- Advertencia de abandonar sin guardar cambios -->
<script>
  var formSubmitting = false;
  var setFormSubmitting = function () { formSubmitting = true; };

  window.onload = function () {
    window.addEventListener("beforeunload", function (e) {
      if (formSubmitting) {
        return undefined;
      }

      var confirmationMessage = 'It looks like you have been editing something. '
        + 'If you leave before saving, your changes will be lost.';

      (e || window.event).returnValue = confirmationMessage; //Gecko + IE
      return confirmationMessage; //Gecko + Webkit, Safari, Chrome etc.
    });
  };
</script>

<!-- Confirmación de creación de registro -->
<script type="text/javascript">
  function confirmarRegistro() {
    var creacion = confirm('¿Está seguro/a de que desea crear el registro?');
    if (creacion) {
      const collection = document.getElementsByClassName("alert alert-success");

      collection[0].setAttribute("style", "display:block");
    }

    return creacion
  }
</script>

</div>

{% endblock %}